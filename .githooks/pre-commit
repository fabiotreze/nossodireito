#!/usr/bin/env python3
"""
Pre-Commit Hook - Valida√ß√£o Completa Antes de Commit
NossoDireito v1.5.0

Este hook executa TODAS as valida√ß√µes antes de permitir commit:
1. Limpeza de arquivos tempor√°rios
2. Valida√ß√£o de sintaxe (JSON, HTML, JS)
3. Valida√ß√£o de conte√∫do (categorias, IPVA, matching engine)
4. Quality gate completo (codereview.py)
5. Valida√ß√£o de fontes oficiais
6. Testes de seguran√ßa (HTTPS, dados sens√≠veis)
7. Checagem de depend√™ncias atualizadas

Se QUALQUER valida√ß√£o falhar, o commit √© bloqueado.

Instala√ß√£o:
    chmod +x .githooks/pre-commit
    git config core.hooksPath .githooks
"""

import subprocess
import sys
from pathlib import Path
from datetime import datetime


class PreCommitValidator:
    """Validador pre-commit completo"""
    
    def __init__(self):
        self.root = Path(__file__).parent.parent
        self.failed = []
    
    def log(self, message, level='INFO'):
        timestamp = datetime.now().strftime('%H:%M:%S')
        symbols = {'INFO': '‚ÑπÔ∏è', 'SUCCESS': '‚úÖ', 'ERROR': '‚ùå', 'WARN': '‚ö†Ô∏è'}
        print(f"[{timestamp}] {symbols.get(level, '‚ÑπÔ∏è')} {message}")
    
    def run_check(self, name, command, required=True):
        """Executa check e registra resultado"""
        self.log(f"Executando: {name}", 'INFO')
        
        try:
            result = subprocess.run(
                command,
                shell=True,
                capture_output=True,
                text=True,
                timeout=120,
                cwd=self.root
            )
            
            if result.returncode == 0:
                self.log(f"‚úì {name} passou", 'SUCCESS')
                return True
            else:
                level = 'ERROR' if required else 'WARN'
                self.log(f"‚úó {name} falhou", level)
                if required:
                    self.failed.append(name)
                    if result.stderr:
                        self.log(f"Erro: {result.stderr[:200]}", 'ERROR')
                return False
        except subprocess.TimeoutExpired:
            self.log(f"‚úó {name} timeout", 'ERROR')
            if required:
                self.failed.append(name)
            return False
        except Exception as e:
            self.log(f"‚úó {name} erro: {str(e)}", 'ERROR')
            if required:
                self.failed.append(name)
            return False
    
    def run(self):
        """Executa todas valida√ß√µes"""
        self.log("=" * 70, 'INFO')
        self.log("PRE-COMMIT HOOK - Valida√ß√£o Completa", 'INFO')
        self.log("=" * 70, 'INFO')
        
        # 1. Limpeza
        self.log("", 'INFO')
        self.log("PASSO 1: LIMPEZA", 'INFO')
        self.run_check(
            "Remover backups",
            'find . -name "*.backup" -type f -delete',
            required=False
        )
        self.run_check(
            "Remover cache Python",
            'find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true',
            required=False
        )
        
        # 2. Valida√ß√£o de Sintaxe
        self.log("", 'INFO')
        self.log("PASSO 2: VALIDA√á√ÉO DE SINTAXE", 'INFO')
        self.run_check(
            "JSON: direitos.json",
            'python3 -c "import json; json.load(open(\'data/direitos.json\'))"',
            required=True
        )
        self.run_check(
            "JSON: matching_engine.json",
            'python3 -c "import json; json.load(open(\'data/matching_engine.json\'))"',
            required=True
        )
        self.run_check(
            "JSON: manifest.json",
            'python3 -c "import json; json.load(open(\'manifest.json\'))"',
            required=True
        )
        self.run_check(
            "HTML: estrutura b√°sica",
            'grep -q "<!DOCTYPE html>" index.html && grep -q "</html>" index.html',
            required=True
        )
        
        # 3. Valida√ß√£o de Conte√∫do
        self.log("", 'INFO')
        self.log("PASSO 3: VALIDA√á√ÉO DE CONTE√öDO", 'INFO')
        self.run_check(
            "Conte√∫do: categorias, IPVA, matching engine",
            'python3 scripts/validate_content.py',
            required=True
        )
        
        # 4. Quality Gate
        self.log("", 'INFO')
        self.log("PASSO 4: QUALITY GATE", 'INFO')
        self.run_check(
            "Quality Gate (score ‚â•75/100)",
            'python3 codereview/codereview.py',
            required=True
        )
        
        # 5. Seguran√ßa
        self.log("", 'INFO')
        self.log("PASSO 5: SEGURAN√áA", 'INFO')
        self.run_check(
            "URLs HTTPS (nenhum HTTP)",
            'grep -i "http://" data/direitos.json && exit 1 || exit 0',
            required=True
        )
        self.run_check(
            "Dados sens√≠veis (nenhum encontrado)",
            'grep -iE "\\b(password|secret|token|api[_-]?key)\\b" data/direitos.json && exit 1 || exit 0',
            required=True
        )
        
        # 6. Performance
        self.log("", 'INFO')
        self.log("PASSO 6: PERFORMANCE", 'INFO')
        self.run_check(
            "HTML <50KB",
            '[ $(stat -f "%z" index.html 2>/dev/null || stat -c "%s" index.html) -lt 50000 ]',
            required=False
        )
        self.run_check(
            "JS <100KB",
            '[ $(stat -f "%z" js/app.js 2>/dev/null || stat -c "%s" js/app.js) -lt 100000 ]',
            required=False
        )
        self.run_check(
            "JSON <150KB",
            '[ $(stat -f "%z" data/direitos.json 2>/dev/null || stat -c "%s" data/direitos.json) -lt 150000 ]',
            required=False
        )
        
        # 7. Depend√™ncias (opcional - pode ser lento)
        # self.log("", 'INFO')
        # self.log("PASSO 7: DEPEND√äNCIAS", 'INFO')
        # self.run_check(
        #     "Verificar depend√™ncias desatualizadas",
        #     'npm outdated || true',
        #     required=False
        # )
        
        # Relat√≥rio Final
        self.log("", 'INFO')
        self.log("=" * 70, 'INFO')
        self.log("RELAT√ìRIO FINAL", 'INFO')
        self.log("=" * 70, 'INFO')
        
        if self.failed:
            self.log("", 'ERROR')
            self.log(f"‚ùå {len(self.failed)} VALIDA√á√ïES FALHARAM:", 'ERROR')
            for name in self.failed:
                self.log(f"  - {name}", 'ERROR')
            self.log("", 'ERROR')
            self.log("üõë COMMIT BLOQUEADO - Corrija os erros acima", 'ERROR')
            self.log("", 'ERROR')
            self.log("Para commitar mesmo assim (N√ÉO RECOMENDADO):", 'WARN')
            self.log("  git commit --no-verify", 'WARN')
            return False
        else:
            self.log("", 'SUCCESS')
            self.log("‚úÖ TODAS VALIDA√á√ïES PASSARAM!", 'SUCCESS')
            self.log("üéâ Commit autorizado", 'SUCCESS')
            return True


if __name__ == '__main__':
    validator = PreCommitValidator()
    success = validator.run()
    sys.exit(0 if success else 1)
