# NossoDireito ‚Äî Deploy para Azure App Service
# Dispara em push na branch main.
# ‚ö†Ô∏è Deploy S√ì executa se Quality Gate passar.

name: Deploy Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - "index.html"
      - "index.min.html"
      - "server.js"
      - "package.json"
      - "css/**"
      - "js/**"
      - "data/**"
      - "images/**"
      - "robots.txt"
      - "sitemap.xml"
      - "sw.js"
      - "manifest.json"
      - "scripts/**"
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  actions: read
  id-token: write

concurrency:
  group: deploy-nossodireito
  cancel-in-progress: false

jobs:
  # ‚îÄ‚îÄ Quality Gate (obrigat√≥rio antes do deploy) ‚îÄ‚îÄ
  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar depend√™ncias
        run: pip install -r requirements.txt

      - name: Scan dados sens√≠veis
        run: |
          FOUND=0
          for ext in pfx pem key p12 env; do
            FILES=$(git ls-files "*.${ext}" 2>/dev/null || true)
            if [ -n "$FILES" ]; then
              echo "‚ùå Arquivo sens√≠vel: $FILES"
              FOUND=$((FOUND + 1))
            fi
          done
          if [ "$FOUND" -gt 0 ]; then exit 1; fi
          echo "‚úÖ Sem dados sens√≠veis."

      - name: Quality Gate (validate_all --quick)
        run: python scripts/validate_all.py --quick

  # ‚îÄ‚îÄ Deploy (s√≥ executa se quality-gate passar) ‚îÄ‚îÄ
  deploy:
    needs: quality-gate
    runs-on: ubuntu-latest
    name: Deploy to App Service
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js 22 LTS
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Azure Login
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Atualizar sitemap.xml lastmod (SEO)
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          sed -i "s|<lastmod>[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}</lastmod>|<lastmod>${TODAY}</lastmod>|" sitemap.xml
          echo "‚úÖ sitemap.xml lastmod ‚Üí ${TODAY}"

      - name: Minificar HTML, JS e CSS
        run: |
          npm install --no-save terser clean-css-cli html-minifier-terser

          npx terser js/app.js --compress --mangle --output js/app.min.js
          ORIG=$(wc -c < js/app.js)
          MINI=$(wc -c < js/app.min.js)
          echo "‚úÖ JS: ${ORIG}B ‚Üí ${MINI}B ($(( (ORIG - MINI) * 100 / ORIG ))% redu√ß√£o)"
          mv js/app.min.js js/app.js

          npx cleancss -o css/styles.min.css css/styles.css
          ORIG_CSS=$(wc -c < css/styles.css)
          MINI_CSS=$(wc -c < css/styles.min.css)
          echo "‚úÖ CSS: ${ORIG_CSS}B ‚Üí ${MINI_CSS}B ($(( (ORIG_CSS - MINI_CSS) * 100 / ORIG_CSS ))% redu√ß√£o)"
          mv css/styles.min.css css/styles.css

          npx html-minifier-terser --collapse-whitespace --remove-comments --minify-css true --minify-js true -o index.min.html index.html
          ORIG_HTML=$(wc -c < index.html)
          MINI_HTML=$(wc -c < index.min.html)
          echo "‚úÖ HTML: ${ORIG_HTML}B ‚Üí ${MINI_HTML}B ($(( (ORIG_HTML - MINI_HTML) * 100 / ORIG_HTML ))% redu√ß√£o)"
          mv index.min.html index.html

      - name: Instalar depend√™ncias (production)
        run: |
          npm ci --production --ignore-scripts 2>/dev/null || npm install --production
          echo "‚úÖ node_modules: $(du -sh node_modules | cut -f1)"

      - name: Criar pacote de deploy
        run: |
          zip -r site.zip \
            index.html server.js package.json package-lock.json \
            robots.txt sitemap.xml sw.js manifest.json \
            node_modules/ css/ js/ data/ images/ \
            -x "*.bak" "*.swa.bak" "__pycache__/*" \
            "terraform/*" ".github/*" "tests/*" "docs/*" \
            "node_modules/.package-lock.json" "node_modules/.cache/*"

          SIZE=$(wc -c < site.zip)
          echo "üì¶ site.zip: ${SIZE} bytes (inclui node_modules)"

      - name: Verificar infraestrutura
        id: infra_check
        run: |
          EXISTS=$(az group exists --name rg-nossodireito)
          echo "rg_exists=${EXISTS}" >> $GITHUB_OUTPUT
          if [ "$EXISTS" != "true" ]; then
            echo "::warning::Resource group 'rg-nossodireito' n√£o encontrado. Execute Terraform apply primeiro."
            echo "‚ÑπÔ∏è V√° em Actions > Terraform > Run workflow > action=apply"
          else
            echo "‚úÖ Resource group existe."
          fi

      - name: Deploy to App Service
        id: deploy
        if: steps.infra_check.outputs.rg_exists == 'true'
        run: |
          # Deploy com --async ‚Äî evita 504 GatewayTimeout em B1
          # || true evita falha se o polling expirar (deploy continua no Azure)
          echo "üì¶ Iniciando deploy..."
          az webapp deploy \
            --resource-group rg-nossodireito \
            --name app-nossodireito \
            --src-path site.zip \
            --type zip \
            --async true \
            --timeout 900 || {
              echo "::warning::Polling expirou ‚Äî verificando via health check"
            }
          echo "‚úÖ Deploy enviado."

      - name: Health check (com retries)
        if: always() && steps.infra_check.outputs.rg_exists == 'true'
        run: |
          echo "‚è≥ Aguardando estabiliza√ß√£o do deploy..."
          MAX_RETRIES=12
          RETRY_DELAY=15
          HEALTH_OK=false

          # 1. Health probe com retry (B1 pode demorar at√© 3min para estabilizar)
          for i in $(seq 1 $MAX_RETRIES); do
            HZ_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 15 \
              "https://app-nossodireito.azurewebsites.net/health" || true)
            echo "üè• Tentativa ${i}/${MAX_RETRIES}: /health ‚Üí HTTP ${HZ_STATUS}"
            if [ "$HZ_STATUS" = "200" ]; then
              HEALTH_OK=true
              break
            fi
            if [ "$i" -lt "$MAX_RETRIES" ]; then
              sleep $RETRY_DELAY
            fi
          done

          if [ "$HEALTH_OK" != "true" ]; then
            echo "::error::/health n√£o respondeu 200 ap√≥s ${MAX_RETRIES} tentativas"
            exit 1
          fi

          FAIL=0

          # 2. Custom domain (deve servir conte√∫do)
          CD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 \
            "https://nossodireito.fabiotreze.com/" || true)
          echo "üåê Custom domain ‚Üí HTTP ${CD_STATUS}"
          if [ "$CD_STATUS" != "200" ]; then
            echo "::warning::Custom domain retornou ${CD_STATUS}"
            FAIL=$((FAIL + 1))
          fi

          # 3. Redirect do dom√≠nio Azure (deve dar 301 para browsers)
          AZ_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-redirs 0 --connect-timeout 10 \
            -H "Accept: text/html" \
            "https://app-nossodireito.azurewebsites.net/" || true)
          echo "üîÄ Azure domain redirect (browser) ‚Üí HTTP ${AZ_STATUS}"
          if [ "$AZ_STATUS" != "301" ]; then
            echo "::warning::Azure domain n√£o redirecionou browser (esperado 301, recebeu ${AZ_STATUS})"
            FAIL=$((FAIL + 1))
          fi

          if [ "$FAIL" -eq 0 ]; then
            echo "‚úÖ Todas as verifica√ß√µes passaram."
          else
            echo "::warning::${FAIL} verifica√ß√£o(√µes) com problema ‚Äî pode estabilizar em alguns segundos."
          fi

      - name: Skip notice
        if: steps.infra_check.outputs.rg_exists != 'true'
        run: |
          echo "::warning::Deploy ignorado ‚Äî infraestrutura n√£o provisionada."
          echo "Execute: Actions ‚Üí Terraform ‚Üí Run workflow ‚Üí action=apply"

  # ‚îÄ‚îÄ Valida√ß√£o de Fontes (p√≥s-deploy, n√£o-bloqueante) ‚îÄ‚îÄ
  validate-sources:
    needs: deploy
    runs-on: ubuntu-latest
    name: Validate Sources (Post-Deploy)
    continue-on-error: true # N√£o bloqueia pipeline se links estiverem lentos
    if: needs.deploy.result == 'success' || needs.deploy.result == 'skipped'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Valida√ß√£o r√°pida (amostra de 5 URLs)
        id: quick_check
        continue-on-error: true
        run: |
          echo "üîó Validando amostra de URLs (quick mode)..."
          python scripts/validate_sources.py --quick --urls || true
          echo "‚úÖ Valida√ß√£o r√°pida conclu√≠da (warnings n√£o bloqueiam)"

      - name: Create issue on validation failure
        if: failure() && steps.quick_check.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '‚ö†Ô∏è Valida√ß√£o de Fontes: Links com Problemas';
            const body = `## Valida√ß√£o de Fontes Falhou

            A valida√ß√£o r√°pida detectou links com problemas ap√≥s o deploy.

            **A√ß√£o Recomendada:**
            1. Execute localmente: \`python scripts/validate_sources.py --urls\`
            2. Verifique se URLs governamentais est√£o temporariamente lentas
            3. Atualize URLs quebrados em \`data/direitos.json\`

            **Links para revisar manualmente:**
            - [Planalto.gov.br](https://www.planalto.gov.br/ccivil_03/)
            - [gov.br Servi√ßos](https://www.gov.br/pt-br/servicos)
            - [INSS](https://meu.inss.gov.br/)

            _Esta issue foi criada automaticamente pelo workflow de deploy._`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['valida√ß√£o', 'fontes']
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['valida√ß√£o', 'fontes', 'automated']
              });
            }
