# NossoDireito ‚Äî Deploy para Azure App Service
# Dispara em push na branch main.
# ‚ö†Ô∏è Deploy S√ì executa se Quality Gate passar.

name: Deploy Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - "index.html"
      - "server.js"
      - "package.json"
      - "css/**"
      - "js/**"
      - "data/**"
      - "images/**"
      - "codereview/**"
      - ".github/workflows/deploy.yml"

concurrency:
  group: deploy-nossodireito
  cancel-in-progress: false

jobs:
  # ‚îÄ‚îÄ Quality Gate (obrigat√≥rio antes do deploy) ‚îÄ‚îÄ
  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Scan dados sens√≠veis
        run: |
          FOUND=0
          for ext in pfx pem key p12 env; do
            FILES=$(git ls-files "*.${ext}" 2>/dev/null || true)
            if [ -n "$FILES" ]; then
              echo "‚ùå Arquivo sens√≠vel: $FILES"
              FOUND=$((FOUND + 1))
            fi
          done
          if [ "$FOUND" -gt 0 ]; then exit 1; fi
          echo "‚úÖ Sem dados sens√≠veis."

      - name: Quality Gate (score >= 75)
        run: python codereview/codereview.py --ci --min-score 75

  # ‚îÄ‚îÄ Deploy (s√≥ executa se quality-gate passar) ‚îÄ‚îÄ
  deploy:
    needs: quality-gate
    runs-on: ubuntu-latest
    name: Deploy to App Service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22 LTS
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Minificar JS e CSS
        run: |
          npm install --no-save terser clean-css-cli

          npx terser js/app.js --compress --mangle --output js/app.min.js
          ORIG=$(wc -c < js/app.js)
          MINI=$(wc -c < js/app.min.js)
          echo "‚úÖ JS: ${ORIG}B ‚Üí ${MINI}B ($(( (ORIG - MINI) * 100 / ORIG ))% redu√ß√£o)"
          mv js/app.min.js js/app.js

          npx cleancss -o css/styles.min.css css/styles.css
          ORIG_CSS=$(wc -c < css/styles.css)
          MINI_CSS=$(wc -c < css/styles.min.css)
          echo "‚úÖ CSS: ${ORIG_CSS}B ‚Üí ${MINI_CSS}B ($(( (ORIG_CSS - MINI_CSS) * 100 / ORIG_CSS ))% redu√ß√£o)"
          mv css/styles.min.css css/styles.css

      - name: Instalar depend√™ncias (production)
        run: |
          npm ci --production --ignore-scripts 2>/dev/null || npm install --production
          echo "‚úÖ node_modules: $(du -sh node_modules | cut -f1)"

      - name: Criar pacote de deploy
        run: |
          zip -r site.zip \
            index.html server.js package.json package-lock.json \
            node_modules/ css/ js/ data/ images/ \
            -x "*.bak" "*.swa.bak" "__pycache__/*" \
            "terraform/*" "codereview/*" ".github/*" "tests/*" "docs/*" \
            "node_modules/.package-lock.json" "node_modules/.cache/*"

          SIZE=$(wc -c < site.zip)
          echo "üì¶ site.zip: ${SIZE} bytes (inclui node_modules)"

      - name: Verificar infraestrutura
        id: infra_check
        run: |
          EXISTS=$(az group exists --name rg-nossodireito)
          echo "rg_exists=${EXISTS}" >> $GITHUB_OUTPUT
          if [ "$EXISTS" != "true" ]; then
            echo "::warning::Resource group 'rg-nossodireito' n√£o encontrado. Execute Terraform apply primeiro."
            echo "‚ÑπÔ∏è V√° em Actions > Terraform > Run workflow > action=apply"
          else
            echo "‚úÖ Resource group existe."
          fi

      - name: Deploy to App Service
        if: steps.infra_check.outputs.rg_exists == 'true'
        run: |
          # Deploy com --async ‚Äî evita 504 GatewayTimeout em B1
          echo "üì¶ Iniciando deploy..."
          az webapp deploy \
            --resource-group rg-nossodireito \
            --name app-nossodireito \
            --src-path site.zip \
            --type zip \
            --async true \
            --timeout 600

          echo "‚úÖ Deploy iniciado (async)."

      - name: Health check
        if: steps.infra_check.outputs.rg_exists == 'true'
        run: |
          echo "‚è≥ Aguardando estabiliza√ß√£o do deploy..."
          sleep 15

          FAIL=0

          # 1. Health probe (deve responder 200 em qualquer host)
          HZ_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://app-nossodireito.azurewebsites.net/healthz" || true)
          echo "üè• /healthz ‚Üí HTTP ${HZ_STATUS}"
          if [ "$HZ_STATUS" != "200" ]; then
            echo "::warning::/healthz retornou ${HZ_STATUS}"
            FAIL=$((FAIL + 1))
          fi

          # 2. Custom domain (deve servir conte√∫do)
          CD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://nossodireito.fabiotreze.com/" || true)
          echo "üåê Custom domain ‚Üí HTTP ${CD_STATUS}"
          if [ "$CD_STATUS" != "200" ]; then
            echo "::warning::Custom domain retornou ${CD_STATUS}"
            FAIL=$((FAIL + 1))
          fi

          # 3. Redirect do dom√≠nio Azure (deve dar 301)
          AZ_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-redirs 0 "https://app-nossodireito.azurewebsites.net/" || true)
          echo "üîÄ Azure domain redirect ‚Üí HTTP ${AZ_STATUS}"
          if [ "$AZ_STATUS" != "301" ]; then
            echo "::warning::Azure domain n√£o est√° redirecionando (esperado 301, recebeu ${AZ_STATUS})"
            FAIL=$((FAIL + 1))
          fi

          if [ "$FAIL" -eq 0 ]; then
            echo "‚úÖ Todas as verifica√ß√µes passaram."
          else
            echo "::warning::${FAIL} verifica√ß√£o(√µes) com problema ‚Äî pode estabilizar em alguns segundos."
          fi

      - name: Skip notice
        if: steps.infra_check.outputs.rg_exists != 'true'
        run: |
          echo "::warning::Deploy ignorado ‚Äî infraestrutura n√£o provisionada."
          echo "Execute: Actions ‚Üí Terraform ‚Üí Run workflow ‚Üí action=apply"
