# NossoDireito â€” RevisÃ£o Semanal de Fontes
# Abre uma issue toda segunda-feira lembrando de revisar as fontes oficiais.
# Para automaÃ§Ã£o completa de verificaÃ§Ã£o de links, descomente a seÃ§Ã£o "link-check".

name: RevisÃ£o Semanal de Fontes

on:
  schedule:
    # Toda segunda-feira Ã s 09:00 UTC (06:00 BRT)
    - cron: "0 9 * * 1"
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  create-review-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Quality Gate (validar cÃ³digo atual)
        id: qg
        continue-on-error: true
        run: |
          RESULT=$(python codereview/codereview.py --ci --min-score 75 2>&1) || true
          SCORE=$(echo "$RESULT" | grep -oP 'Score Total: \K[0-9.]+' || echo "N/A")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          if echo "$RESULT" | grep -q "QUALITY GATE PASSOU"; then
            echo "status=âœ… PASSOU ($SCORE/100)" >> "$GITHUB_OUTPUT"
          else
            echo "status=âŒ FALHOU ($SCORE/100)" >> "$GITHUB_OUTPUT"
          fi

      - name: Health check do site
        id: health
        continue-on-error: true
        run: |
          HZ=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://app-nossodireito.azurewebsites.net/healthz" 2>/dev/null || echo "ERRO")
          CD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://nossodireito.fabiotreze.com/" 2>/dev/null || echo "ERRO")
          RD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --max-redirs 0 "https://app-nossodireito.azurewebsites.net/" 2>/dev/null || echo "ERRO")

          echo "healthz=$HZ" >> "$GITHUB_OUTPUT"
          echo "custom_domain=$CD" >> "$GITHUB_OUTPUT"
          echo "redirect=$RD" >> "$GITHUB_OUTPUT"

          STATUS="âœ…"
          if [ "$HZ" != "200" ] || [ "$CD" != "200" ] || [ "$RD" != "301" ]; then
            STATUS="âš ï¸"
          fi
          echo "overall=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Extrair fontes do JSON
        id: fontes
        run: |
          VERSAO=$(jq -r '.versao' data/direitos.json)
          ULTIMA=$(jq -r '.ultima_atualizacao' data/direitos.json)
          NUM_FONTES=$(jq '.fontes | length' data/direitos.json)
          NUM_CATEGORIAS=$(jq '.categorias | length' data/direitos.json)
          echo "versao=$VERSAO" >> "$GITHUB_OUTPUT"
          echo "ultima=$ULTIMA" >> "$GITHUB_OUTPUT"
          echo "num_fontes=$NUM_FONTES" >> "$GITHUB_OUTPUT"
          echo "num_categorias=$NUM_CATEGORIAS" >> "$GITHUB_OUTPUT"

      - name: Verificar fontes legislativas por mudanÃ§as recentes
        id: legcheck
        continue-on-error: true
        run: |
          echo "## VerificaÃ§Ã£o de MudanÃ§as Legislativas" > leg-report.md
          echo "" >> leg-report.md
          echo "### Sites oficiais para revisar manualmente:" >> leg-report.md
          echo "" >> leg-report.md
          echo "| Fonte | URL | O que verificar |" >> leg-report.md
          echo "|-------|-----|-----------------|" >> leg-report.md
          echo "| Planalto | https://www.planalto.gov.br/ccivil_03/ | Novas leis PcD |" >> leg-report.md
          echo "| DOU | https://www.in.gov.br/servicos/diario-oficial-da-uniao | Decretos e portarias |" >> leg-report.md
          echo "| gov.br INSS | https://www.gov.br/inss/pt-br/noticias | MudanÃ§as BPC/benefÃ­cios |" >> leg-report.md
          echo "| ANS | https://www.gov.br/ans/pt-br/assuntos/noticias | Rol de procedimentos |" >> leg-report.md
          echo "| Min. Cidades | https://www.gov.br/cidades/pt-br | Minha Casa Minha Vida |" >> leg-report.md
          echo "| ABNT | https://www.abntcatalogo.com.br/ | NBR 9050 atualizaÃ§Ãµes |" >> leg-report.md
          echo "" >> leg-report.md

          # Check key pages for PcD content updates
          CHANGES=0
          echo "### DetecÃ§Ã£o automÃ¡tica de pÃ¡ginas com conteÃºdo PcD:" >> leg-report.md
          echo "" >> leg-report.md

          # Check LBI page
          LBI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null || echo "ERRO")
          LBI_SIZE=$(curl -s --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null | wc -c)
          echo "- LBI (Lei 13.146/2015): HTTP $LBI_STATUS, $LBI_SIZE bytes" >> leg-report.md

          echo "" >> leg-report.md
          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Validar cÃ³digos CID (OMS ICD API)
        id: cidcheck
        continue-on-error: true
        env:
          ICD_CLIENT_ID: ${{ secrets.ICD_CLIENT_ID }}
          ICD_CLIENT_SECRET: ${{ secrets.ICD_CLIENT_SECRET }}
        run: |
          pip install requests > /dev/null 2>&1
          if [ -z "$ICD_CLIENT_ID" ] || [ -z "$ICD_CLIENT_SECRET" ]; then
            echo "âš ï¸ ICD_CLIENT_ID / ICD_CLIENT_SECRET nÃ£o configurados â€” pulando validaÃ§Ã£o CID." > cid-report.md
            echo "cid_ok=0" >> "$GITHUB_OUTPUT"
            echo "cid_total=0" >> "$GITHUB_OUTPUT"
            echo "cid_errors=0" >> "$GITHUB_OUTPUT"
          else
            RESULT=$(python scripts/validate_sources.py --cid --json 2>&1) || true
            echo "$RESULT" > cid-raw.json

            CID_OK=$(echo "$RESULT" | grep -oP '"ok":\s*\K[0-9]+' || echo "0")
            CID_TOTAL=$(echo "$RESULT" | grep -oP '"total":\s*\K[0-9]+' || echo "0")
            CID_ERRORS=$((CID_TOTAL - CID_OK))

            echo "cid_ok=$CID_OK" >> "$GITHUB_OUTPUT"
            echo "cid_total=$CID_TOTAL" >> "$GITHUB_OUTPUT"
            echo "cid_errors=$CID_ERRORS" >> "$GITHUB_OUTPUT"

            echo "## ValidaÃ§Ã£o CID (OMS ICD API)" > cid-report.md
            echo "" >> cid-report.md
            if [ "$CID_ERRORS" = "0" ]; then
              echo "âœ… **$CID_OK/$CID_TOTAL** cÃ³digos CID validados com sucesso." >> cid-report.md
            else
              echo "âŒ **$CID_ERRORS/$CID_TOTAL** cÃ³digos CID com erro." >> cid-report.md
            fi
          fi

      - name: Criar issue de revisÃ£o
        uses: actions/github-script@v7
        env:
          VERSAO: ${{ steps.fontes.outputs.versao }}
          ULTIMA: ${{ steps.fontes.outputs.ultima }}
          NUM_FONTES: ${{ steps.fontes.outputs.num_fontes }}
          NUM_CATEGORIAS: ${{ steps.fontes.outputs.num_categorias }}
          QG_STATUS: ${{ steps.qg.outputs.status }}
          HEALTH_OVERALL: ${{ steps.health.outputs.overall }}
          HEALTH_HZ: ${{ steps.health.outputs.healthz }}
          HEALTH_CD: ${{ steps.health.outputs.custom_domain }}
          HEALTH_RD: ${{ steps.health.outputs.redirect }}
          CID_OK: ${{ steps.cidcheck.outputs.cid_ok }}
          CID_TOTAL: ${{ steps.cidcheck.outputs.cid_total }}
          CID_ERRORS: ${{ steps.cidcheck.outputs.cid_errors }}
        with:
          script: |
            const fs = require('fs');
            const legReport = fs.readFileSync('leg-report.md', 'utf8');
            const cidReport = fs.existsSync('cid-report.md') ? fs.readFileSync('cid-report.md', 'utf8') : 'âš ï¸ RelatÃ³rio CID nÃ£o disponÃ­vel.';
            const today = new Date().toISOString().split('T')[0];

            const body = `# ğŸ“‹ RevisÃ£o Semanal â€” ${today}

            **VersÃ£o atual:** v${process.env.VERSAO}
            **Ãšltima atualizaÃ§Ã£o:** ${process.env.ULTIMA}
            **Fontes cadastradas:** ${process.env.NUM_FONTES}
            **Categorias:** ${process.env.NUM_CATEGORIAS}

            ## ğŸ¥ Status do Site

            | VerificaÃ§Ã£o | Resultado |
            |-------------|-----------|
            | Quality Gate | ${process.env.QG_STATUS} |
            | Health Probe (/healthz) | HTTP ${process.env.HEALTH_HZ} |
            | Custom Domain | HTTP ${process.env.HEALTH_CD} |
            | Redirect Azure | HTTP ${process.env.HEALTH_RD} |
            | CID (OMS ICD API) | ${process.env.CID_OK}/${process.env.CID_TOTAL} âœ… |
            | **Status Geral** | **${process.env.HEALTH_OVERALL}** |

            ## Checklist de RevisÃ£o

            ### ğŸ“œ LegislaÃ§Ã£o
            - [ ] Verificar se houve alteraÃ§Ãµes legislativas (planalto.gov.br)
            - [ ] Conferir valores atualizados (salÃ¡rio mÃ­nimo, BPC)
            - [ ] Checar novas leis ou decretos relevantes para PcD
            - [ ] Verificar DiÃ¡rio Oficial da UniÃ£o (in.gov.br) para portarias e decretos
            - [ ] Checar se houve mudanÃ§as no Minha Casa Minha Vida (gov.br/cidades)

            ### ğŸ›ï¸ ServiÃ§os
            - [ ] Testar links de serviÃ§os (gov.br, INSS, ANS)
            - [ ] Verificar se os procedimentos/passos continuam os mesmos
            - [ ] Checar se hÃ¡ novos serviÃ§os digitais disponÃ­veis

            ### ğŸ“‹ ConteÃºdo
            - [ ] Revisar dicas e orientaÃ§Ãµes por categoria
            - [ ] Verificar se documentos necessÃ¡rios mudaram
            - [ ] Atualizar data de "ultima_atualizacao" e "proxima_revisao" no JSON

            ### ğŸ  Categorias
            - [ ] Verificar se algum direito PcD novo surgiu (ver backlog no GOVERNANCE.md)
            - [ ] Checar se alguma categoria existente precisa de atualizaÃ§Ã£o de valores
            - [ ] Verificar cobertura de instituiÃ§Ãµes para todas as categorias
            - [ ] Rodar \`python codereview/codereview.py --categoria schema\` para validar

            ### ğŸ”— VerificaÃ§Ã£o de Links
            > **Nota:** Link check automÃ¡tico foi removido devido a falsos positivos (sites gov.br bloqueiam CI runners).
            > Teste os links manualmente ou use o script \`scripts/validate_sources.py\` localmente.

            ### ğŸ“œ VerificaÃ§Ã£o Legislativa
            ${legReport}

            ### ğŸ¥ ValidaÃ§Ã£o CID
            ${cidReport}

            ---
            *Issue criada automaticamente pelo workflow de revisÃ£o semanal.*
            *Consulte GOVERNANCE.md para critÃ©rios de adiÃ§Ã£o de fontes e categorias.*
            *ApÃ³s a revisÃ£o, atualize \`ultima_atualizacao\` e \`proxima_revisao\` em \`data/direitos.json\`.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“‹ RevisÃ£o semanal de fontes â€” ${today}`,
              body: body,
              labels: ['revisÃ£o-semanal', 'fontes']
            });
