# NossoDireito ‚Äî Revis√£o Peri√≥dica de Fontes
# Abre uma issue periodicamente lembrando de revisar as fontes oficiais.
# Para automa√ß√£o completa de verifica√ß√£o de links, descomente a se√ß√£o "link-check".

name: Revis√£o Peri√≥dica de Fontes

on:
  schedule:
    # Toda segunda-feira √†s 09:00 UTC (06:00 BRT)
    - cron: "0 9 * * 1"
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  create-review-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar depend√™ncias
        run: pip install -r requirements.txt

      - name: Quality Gate (validar c√≥digo atual)
        id: qg
        continue-on-error: true
        run: |
          python scripts/validate_all.py --quick > qg_result.txt 2>&1 || true
          SCORE=$(cat validation_report.json | python -c "import json,sys; d=json.load(sys.stdin); print(f\"{d['summary']['passed']}/{d['summary']['total']}\")" 2>/dev/null || echo "N/A")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          if [ -f validation_report.json ]; then
            echo "status=‚úÖ PASSOU ($SCORE)" >> "$GITHUB_OUTPUT"
          else
            echo "status=‚ùå FALHOU ($SCORE)" >> "$GITHUB_OUTPUT"
          fi

      - name: Health check do site
        id: health
        continue-on-error: true
        run: |
          HZ=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://app-nossodireito.azurewebsites.net/health" 2>/dev/null || echo "ERRO")
          CD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://nossodireito.fabiotreze.com/" 2>/dev/null || echo "ERRO")
          RD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --max-redirs 0 "https://app-nossodireito.azurewebsites.net/" 2>/dev/null || echo "ERRO")

          echo "health=$HZ" >> "$GITHUB_OUTPUT"
          echo "custom_domain=$CD" >> "$GITHUB_OUTPUT"
          echo "redirect=$RD" >> "$GITHUB_OUTPUT"

          STATUS="‚úÖ"
          if [ "$HZ" != "200" ] || [ "$CD" != "200" ] || [ "$RD" != "301" ]; then
            STATUS="‚ö†Ô∏è"
          fi
          echo "overall=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Extrair fontes do JSON
        id: fontes
        run: |
          VERSAO=$(jq -r '.versao' data/direitos.json)
          ULTIMA=$(jq -r '.ultima_atualizacao' data/direitos.json)
          NUM_FONTES=$(jq '.fontes | length' data/direitos.json)
          NUM_CATEGORIAS=$(jq '.categorias | length' data/direitos.json)
          echo "versao=$VERSAO" >> "$GITHUB_OUTPUT"
          echo "ultima=$ULTIMA" >> "$GITHUB_OUTPUT"
          echo "num_fontes=$NUM_FONTES" >> "$GITHUB_OUTPUT"
          echo "num_categorias=$NUM_CATEGORIAS" >> "$GITHUB_OUTPUT"

      - name: Valida√ß√£o completa de fontes (URLs)
        id: validate_urls
        continue-on-error: true
        run: |
          echo "üîó Validando todas as URLs das fontes oficiais..."
          python scripts/validate_sources.py --urls --json > url-validation.json || true

          # Extract summary
          TOTAL=$(jq '.total' url-validation.json)
          OK=$(jq '.ok' url-validation.json)
          WARNINGS=$(jq '.warnings' url-validation.json)
          ERRORS=$(jq '.errors' url-validation.json)
          SCORE=$(echo "scale=1; $OK * 100 / $TOTAL" | bc)

          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "ok=$OK" >> "$GITHUB_OUTPUT"
          echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"

          # Generate markdown report
          echo "## üîó Valida√ß√£o de URLs" > url-report.md
          echo "" >> url-report.md
          echo "**Total:** $TOTAL URLs | **‚úÖ OK:** $OK | **‚ö†Ô∏è Warnings:** $WARNINGS | **‚ùå Erros:** $ERRORS" >> url-report.md
          echo "" >> url-report.md
          echo "**Score de Valida√ß√£o:** $SCORE%" >> url-report.md
          echo "" >> url-report.md

          if [ "$ERRORS" -gt 0 ]; then
            echo "### ‚ùå URLs com Erro:" >> url-report.md
            echo "" >> url-report.md
            jq -r '.results[] | select(.status == "error") | "- **\(.item)**: \(.message) ([link](\(.url)))"' url-validation.json >> url-report.md
            echo "" >> url-report.md
          fi

          if [ "$WARNINGS" -gt 0 ]; then
            echo "### ‚ö†Ô∏è URLs com Avisos:" >> url-report.md
            echo "" >> url-report.md
            jq -r '.results[] | select(.status == "warning") | "- **\(.item)**: \(.message) ([link](\(.url)))"' url-validation.json >> url-report.md
            echo "" >> url-report.md
          fi

          echo "‚úÖ Valida√ß√£o completa gerada em url-report.md"

      - name: Descoberta autom√°tica de novos benef√≠cios PcD
        id: discovery
        continue-on-error: true
        run: |
          echo "üîç Executando descoberta autom√°tica de novos benef√≠cios..."
          python scripts/discover_benefits.py --since 14 --json > discovery_output.json 2>discovery_log.txt || true

          DISC_TOTAL=$(jq '.candidates_found // 0' discovery_output.json 2>/dev/null || echo "0")
          DISC_ALTA=$(jq '.candidates_by_priority.ALTA // 0' discovery_output.json 2>/dev/null || echo "0")

          echo "disc_total=$DISC_TOTAL" >> "$GITHUB_OUTPUT"
          echo "disc_alta=$DISC_ALTA" >> "$GITHUB_OUTPUT"

          # Gera relat√≥rio MD
          echo "## üÜï Descoberta Autom√°tica de Benef√≠cios" > disc-report.md
          echo "" >> disc-report.md
          if [ "$DISC_TOTAL" -gt 0 ]; then
            echo "**$DISC_TOTAL candidatos encontrados** ($DISC_ALTA prioridade ALTA)" >> disc-report.md
            echo "" >> disc-report.md
            jq -r '.candidates[] | "- \(if .priority == "ALTA" then "üî¥" elif .priority == "M√âDIA" then "üü°" else "üü¢" end) **\(.title[:80])** (\(.source)) ‚Üí `\(.suggested_category)`"' discovery_output.json >> disc-report.md 2>/dev/null
          else
            echo "‚úÖ Nenhum benef√≠cio novo detectado esta semana." >> disc-report.md
          fi
          echo "" >> disc-report.md

      - name: Verificar fontes legislativas por mudan√ßas recentes
        id: legcheck
        continue-on-error: true
        run: |
          echo "## Verifica√ß√£o de Mudan√ßas Legislativas" > leg-report.md
          echo "" >> leg-report.md
          echo "### Sites oficiais para revisar manualmente:" >> leg-report.md
          echo "" >> leg-report.md
          echo "| Fonte | URL | O que verificar |" >> leg-report.md
          echo "|-------|-----|-----------------|" >> leg-report.md
          echo "| Planalto | https://www.planalto.gov.br/ccivil_03/ | Novas leis PcD |" >> leg-report.md
          echo "| DOU | https://www.in.gov.br/servicos/diario-oficial-da-uniao | Decretos e portarias |" >> leg-report.md
          echo "| gov.br INSS | https://www.gov.br/inss/pt-br/noticias | Mudan√ßas BPC/benef√≠cios |" >> leg-report.md
          echo "| ANS | https://www.gov.br/ans/pt-br/assuntos/noticias | Rol de procedimentos |" >> leg-report.md
          echo "| Min. Cidades | https://www.gov.br/cidades/pt-br | Minha Casa Minha Vida |" >> leg-report.md
          echo "| ABNT | https://www.abntcatalogo.com.br/ | NBR 9050 atualiza√ß√µes |" >> leg-report.md
          echo "" >> leg-report.md

          # Check key pages for PcD content updates
          CHANGES=0
          echo "### Detec√ß√£o autom√°tica de p√°ginas com conte√∫do PcD:" >> leg-report.md
          echo "" >> leg-report.md

          # Check LBI page
          LBI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null || echo "ERRO")
          LBI_SIZE=$(curl -s --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null | wc -c)
          echo "- LBI (Lei 13.146/2015): HTTP $LBI_STATUS, $LBI_SIZE bytes" >> leg-report.md

          echo "" >> leg-report.md
          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Validar c√≥digos CID (OMS ICD API)
        id: cidcheck
        continue-on-error: true
        env:
          ICD_CLIENT_ID: ${{ secrets.ICD_CLIENT_ID }}
          ICD_CLIENT_SECRET: ${{ secrets.ICD_CLIENT_SECRET }}
        run: |
          pip install requests > /dev/null 2>&1
          if [ -z "$ICD_CLIENT_ID" ] || [ -z "$ICD_CLIENT_SECRET" ]; then
            echo "‚ö†Ô∏è ICD_CLIENT_ID / ICD_CLIENT_SECRET n√£o configurados ‚Äî pulando valida√ß√£o CID." > cid-report.md
            echo "cid_ok=0" >> "$GITHUB_OUTPUT"
            echo "cid_total=0" >> "$GITHUB_OUTPUT"
            echo "cid_errors=0" >> "$GITHUB_OUTPUT"
          else
            RESULT=$(python scripts/validate_sources.py --cid --json 2>&1) || true
            echo "$RESULT" > cid-raw.json

            CID_OK=$(echo "$RESULT" | grep -oP '"ok":\s*\K[0-9]+' || echo "0")
            CID_TOTAL=$(echo "$RESULT" | grep -oP '"total":\s*\K[0-9]+' || echo "0")
            CID_ERRORS=$((CID_TOTAL - CID_OK))

            echo "cid_ok=$CID_OK" >> "$GITHUB_OUTPUT"
            echo "cid_total=$CID_TOTAL" >> "$GITHUB_OUTPUT"
            echo "cid_errors=$CID_ERRORS" >> "$GITHUB_OUTPUT"

            echo "## Valida√ß√£o CID (OMS ICD API)" > cid-report.md
            echo "" >> cid-report.md
            if [ "$CID_ERRORS" = "0" ]; then
              echo "‚úÖ **$CID_OK/$CID_TOTAL** c√≥digos CID validados com sucesso." >> cid-report.md
            else
              echo "‚ùå **$CID_ERRORS/$CID_TOTAL** c√≥digos CID com erro." >> cid-report.md
            fi
          fi

      - name: Criar issue de revis√£o
        uses: actions/github-script@v7
        env:
          VERSAO: ${{ steps.fontes.outputs.versao }}
          ULTIMA: ${{ steps.fontes.outputs.ultima }}
          NUM_FONTES: ${{ steps.fontes.outputs.num_fontes }}
          NUM_CATEGORIAS: ${{ steps.fontes.outputs.num_categorias }}
          QG_STATUS: ${{ steps.qg.outputs.status }}
          HEALTH_OVERALL: ${{ steps.health.outputs.overall }}
          HEALTH_HZ: ${{ steps.health.outputs.health }}
          HEALTH_CD: ${{ steps.health.outputs.custom_domain }}
          HEALTH_RD: ${{ steps.health.outputs.redirect }}
          CID_OK: ${{ steps.cidcheck.outputs.cid_ok }}
          CID_TOTAL: ${{ steps.cidcheck.outputs.cid_total }}
          CID_ERRORS: ${{ steps.cidcheck.outputs.cid_errors }}
          URL_SCORE: ${{ steps.validate_urls.outputs.score }}
          URL_ERRORS: ${{ steps.validate_urls.outputs.errors }}
          URL_WARNINGS: ${{ steps.validate_urls.outputs.warnings }}
          DISC_TOTAL: ${{ steps.discovery.outputs.disc_total }}
          DISC_ALTA: ${{ steps.discovery.outputs.disc_alta }}
        with:
          script: |
            const fs = require('fs');
            const legReport = fs.existsSync('leg-report.md') ? fs.readFileSync('leg-report.md', 'utf8') : '‚ö†Ô∏è Relat√≥rio legislativo n√£o dispon√≠vel.';
            const cidReport = fs.existsSync('cid-report.md') ? fs.readFileSync('cid-report.md', 'utf8') : '‚ö†Ô∏è Relat√≥rio CID n√£o dispon√≠vel.';
            const urlReport = fs.existsSync('url-report.md') ? fs.readFileSync('url-report.md', 'utf8') : '‚ö†Ô∏è Valida√ß√£o de URLs n√£o executada.';
            const discReport = fs.existsSync('disc-report.md') ? fs.readFileSync('disc-report.md', 'utf8') : '‚ö†Ô∏è Descoberta autom√°tica n√£o executada.';
            const today = new Date().toISOString().split('T')[0];

            const e = (v, fallback = 'N/A') => process.env[v] || fallback;

            const body = [
              `# üìã Revis√£o Peri√≥dica ‚Äî ${today}`,
              '',
              `**Vers√£o atual:** v${e('VERSAO')}`,
              `**√öltima atualiza√ß√£o:** ${e('ULTIMA')}`,
              `**Fontes cadastradas:** ${e('NUM_FONTES')}`,
              `**Categorias:** ${e('NUM_CATEGORIAS')}`,
              '',
              '## üè• Status do Site',
              '',
              '| Verifica√ß√£o | Resultado |',
              '|-------------|-----------|',
              `| Quality Gate | ${e('QG_STATUS')} |`,
              `| Health Probe (/health) | HTTP ${e('HEALTH_HZ')} |`,
              `| Custom Domain | HTTP ${e('HEALTH_CD')} |`,
              `| Redirect Azure | HTTP ${e('HEALTH_RD')} |`,
              `| URL Validation | ${e('URL_SCORE', '?')}% (${e('URL_ERRORS', '?')} erros, ${e('URL_WARNINGS', '?')} avisos) |`,
              `| CID (OMS ICD API) | ${e('CID_OK', '?')}/${e('CID_TOTAL', '?')} ‚úÖ |`,
              `| **Status Geral** | **${e('HEALTH_OVERALL')}** |`,
              '',
              '## Checklist de Revis√£o',
              '',
              '### üìú Legisla√ß√£o',
              '- [ ] Verificar se houve altera√ß√µes legislativas (planalto.gov.br)',
              '- [ ] Conferir valores atualizados (sal√°rio m√≠nimo, BPC)',
              '- [ ] Checar novas leis ou decretos relevantes para PcD',
              '- [ ] Verificar Di√°rio Oficial da Uni√£o (in.gov.br) para portarias e decretos',
              '- [ ] Checar se houve mudan√ßas no Minha Casa Minha Vida (gov.br/cidades)',
              '',
              '### üèõÔ∏è Servi√ßos',
              '- [ ] Testar links de servi√ßos (gov.br, INSS, ANS)',
              '- [ ] Verificar se os procedimentos/passos continuam os mesmos',
              '- [ ] Checar se h√° novos servi√ßos digitais dispon√≠veis',
              '',
              '### üìã Conte√∫do',
              '- [ ] Revisar dicas e orienta√ß√µes por categoria',
              '- [ ] Verificar se documentos necess√°rios mudaram',
              '- [ ] Atualizar data de "ultima_atualizacao" no JSON',
              '',
              '### üè† Categorias',
              '- [ ] Verificar se algum direito PcD novo surgiu (ver backlog no GOVERNANCE.md)',
              '- [ ] Checar se alguma categoria existente precisa de atualiza√ß√£o de valores',
              '- [ ] Verificar cobertura de institui√ß√µes para todas as categorias',
              '- [ ] Rodar `python scripts/validate_content.py` para validar schema',
              '',
              '### üîó Verifica√ß√£o de Links',
              urlReport,
              '',
              '### üìú Verifica√ß√£o Legislativa',
              legReport,
              '',
              '### üè• Valida√ß√£o CID',
              cidReport,
              '',
              '### üÜï Descoberta Autom√°tica de Benef√≠cios',
              discReport,
              '',
              '---',
              '*Issue criada automaticamente pelo workflow de revis√£o peri√≥dica.*',
              '*Consulte GOVERNANCE.md para crit√©rios de adi√ß√£o de fontes e categorias.*',
              '*Ap√≥s a revis√£o, atualize `ultima_atualizacao` em `data/direitos.json`.*',
            ].join('\n');

            // Ensure labels exist before creating the issue
            const labels = ['revis√£o-peri√≥dica', 'fontes'];
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: label === 'revis√£o-peri√≥dica' ? '0075ca' : 'd876e3',
                });
              }
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìã Revis√£o peri√≥dica de fontes ‚Äî ${today}`,
              body: body,
              labels: labels,
            });
