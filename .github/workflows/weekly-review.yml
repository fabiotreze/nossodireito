# NossoDireito ‚Äî Revis√£o Semanal de Fontes
# Abre uma issue toda segunda-feira lembrando de revisar as fontes oficiais.
# Para automa√ß√£o completa de verifica√ß√£o de links, descomente a se√ß√£o "link-check".

name: Revis√£o Semanal de Fontes

on:
  schedule:
    # Toda segunda-feira √†s 09:00 UTC (06:00 BRT)
    - cron: "0 9 * * 1"
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  create-review-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Quality Gate (validar c√≥digo atual)
        id: qg
        continue-on-error: true
        run: |
          RESULT=$(python codereview/codereview.py --ci --min-score 75 2>&1) || true
          SCORE=$(echo "$RESULT" | grep -oP 'Score Total: \K[0-9.]+' || echo "N/A")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          if echo "$RESULT" | grep -q "QUALITY GATE PASSOU"; then
            echo "status=‚úÖ PASSOU ($SCORE/100)" >> "$GITHUB_OUTPUT"
          else
            echo "status=‚ùå FALHOU ($SCORE/100)" >> "$GITHUB_OUTPUT"
          fi

      - name: Health check do site
        id: health
        continue-on-error: true
        run: |
          HZ=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://app-nossodireito.azurewebsites.net/healthz" 2>/dev/null || echo "ERRO")
          CD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://nossodireito.fabiotreze.com/" 2>/dev/null || echo "ERRO")
          RD=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --max-redirs 0 "https://app-nossodireito.azurewebsites.net/" 2>/dev/null || echo "ERRO")

          echo "healthz=$HZ" >> "$GITHUB_OUTPUT"
          echo "custom_domain=$CD" >> "$GITHUB_OUTPUT"
          echo "redirect=$RD" >> "$GITHUB_OUTPUT"

          STATUS="‚úÖ"
          if [ "$HZ" != "200" ] || [ "$CD" != "200" ] || [ "$RD" != "301" ]; then
            STATUS="‚ö†Ô∏è"
          fi
          echo "overall=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Extrair fontes do JSON
        id: fontes
        run: |
          VERSAO=$(jq -r '.versao' data/direitos.json)
          ULTIMA=$(jq -r '.ultima_atualizacao' data/direitos.json)
          NUM_FONTES=$(jq '.fontes | length' data/direitos.json)
          NUM_CATEGORIAS=$(jq '.categorias | length' data/direitos.json)
          echo "versao=$VERSAO" >> "$GITHUB_OUTPUT"
          echo "ultima=$ULTIMA" >> "$GITHUB_OUTPUT"
          echo "num_fontes=$NUM_FONTES" >> "$GITHUB_OUTPUT"
          echo "num_categorias=$NUM_CATEGORIAS" >> "$GITHUB_OUTPUT"

      - name: Verificar links das fontes
        id: linkcheck
        continue-on-error: true
        run: |
          echo "## Verifica√ß√£o de Links" > link-report.md
          echo "" >> link-report.md
          BROKEN=0
          while IFS= read -r url; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" --max-time 10 -L "$url" 2>/dev/null || echo "ERRO")
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
              echo "- ‚úÖ \`$STATUS\` ‚Äî $url" >> link-report.md
            else
              echo "- ‚ùå \`$STATUS\` ‚Äî $url" >> link-report.md
              BROKEN=$((BROKEN + 1))
            fi
          done < <(jq -r '.fontes[].url' data/direitos.json)
          echo "" >> link-report.md
          echo "broken=$BROKEN" >> "$GITHUB_OUTPUT"

      - name: Verificar fontes legislativas por mudan√ßas recentes
        id: legcheck
        continue-on-error: true
        run: |
          echo "## Verifica√ß√£o de Mudan√ßas Legislativas" > leg-report.md
          echo "" >> leg-report.md
          echo "### Sites oficiais para revisar manualmente:" >> leg-report.md
          echo "" >> leg-report.md
          echo "| Fonte | URL | O que verificar |" >> leg-report.md
          echo "|-------|-----|-----------------|" >> leg-report.md
          echo "| Planalto | https://www.planalto.gov.br/ccivil_03/ | Novas leis PcD |" >> leg-report.md
          echo "| DOU | https://www.in.gov.br/servicos/diario-oficial-da-uniao | Decretos e portarias |" >> leg-report.md
          echo "| gov.br INSS | https://www.gov.br/inss/pt-br/noticias | Mudan√ßas BPC/benef√≠cios |" >> leg-report.md
          echo "| ANS | https://www.gov.br/ans/pt-br/assuntos/noticias | Rol de procedimentos |" >> leg-report.md
          echo "| Min. Cidades | https://www.gov.br/cidades/pt-br | Minha Casa Minha Vida |" >> leg-report.md
          echo "| ABNT | https://www.abntcatalogo.com.br/ | NBR 9050 atualiza√ß√µes |" >> leg-report.md
          echo "" >> leg-report.md

          # Check key pages for PcD content updates
          CHANGES=0
          echo "### Detec√ß√£o autom√°tica de p√°ginas com conte√∫do PcD:" >> leg-report.md
          echo "" >> leg-report.md

          # Check LBI page
          LBI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null || echo "ERRO")
          LBI_SIZE=$(curl -s --max-time 10 -L "https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm" 2>/dev/null | wc -c)
          echo "- LBI (Lei 13.146/2015): HTTP $LBI_STATUS, $LBI_SIZE bytes" >> leg-report.md

          echo "" >> leg-report.md
          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Validar c√≥digos CID (OMS ICD API)
        id: cidcheck
        continue-on-error: true
        env:
          ICD_CLIENT_ID: ${{ secrets.ICD_CLIENT_ID }}
          ICD_CLIENT_SECRET: ${{ secrets.ICD_CLIENT_SECRET }}
        run: |
          pip install requests > /dev/null 2>&1
          if [ -z "$ICD_CLIENT_ID" ] || [ -z "$ICD_CLIENT_SECRET" ]; then
            echo "‚ö†Ô∏è ICD_CLIENT_ID / ICD_CLIENT_SECRET n√£o configurados ‚Äî pulando valida√ß√£o CID." > cid-report.md
            echo "cid_ok=0" >> "$GITHUB_OUTPUT"
            echo "cid_total=0" >> "$GITHUB_OUTPUT"
            echo "cid_errors=0" >> "$GITHUB_OUTPUT"
          else
            RESULT=$(python scripts/validate_sources.py --cid --json 2>&1) || true
            echo "$RESULT" > cid-raw.json

            CID_OK=$(echo "$RESULT" | grep -oP '"ok":\s*\K[0-9]+' || echo "0")
            CID_TOTAL=$(echo "$RESULT" | grep -oP '"total":\s*\K[0-9]+' || echo "0")
            CID_ERRORS=$((CID_TOTAL - CID_OK))

            echo "cid_ok=$CID_OK" >> "$GITHUB_OUTPUT"
            echo "cid_total=$CID_TOTAL" >> "$GITHUB_OUTPUT"
            echo "cid_errors=$CID_ERRORS" >> "$GITHUB_OUTPUT"

            echo "## Valida√ß√£o CID (OMS ICD API)" > cid-report.md
            echo "" >> cid-report.md
            if [ "$CID_ERRORS" = "0" ]; then
              echo "‚úÖ **$CID_OK/$CID_TOTAL** c√≥digos CID validados com sucesso." >> cid-report.md
            else
              echo "‚ùå **$CID_ERRORS/$CID_TOTAL** c√≥digos CID com erro." >> cid-report.md
            fi
          fi

      - name: Criar issue de revis√£o
        uses: actions/github-script@v7
        env:
          VERSAO: ${{ steps.fontes.outputs.versao }}
          ULTIMA: ${{ steps.fontes.outputs.ultima }}
          NUM_FONTES: ${{ steps.fontes.outputs.num_fontes }}
          NUM_CATEGORIAS: ${{ steps.fontes.outputs.num_categorias }}
          BROKEN: ${{ steps.linkcheck.outputs.broken }}
          QG_STATUS: ${{ steps.qg.outputs.status }}
          HEALTH_OVERALL: ${{ steps.health.outputs.overall }}
          HEALTH_HZ: ${{ steps.health.outputs.healthz }}
          HEALTH_CD: ${{ steps.health.outputs.custom_domain }}
          HEALTH_RD: ${{ steps.health.outputs.redirect }}
          CID_OK: ${{ steps.cidcheck.outputs.cid_ok }}
          CID_TOTAL: ${{ steps.cidcheck.outputs.cid_total }}
          CID_ERRORS: ${{ steps.cidcheck.outputs.cid_errors }}
        with:
          script: |
            const fs = require('fs');
            const linkReport = fs.readFileSync('link-report.md', 'utf8');
            const legReport = fs.readFileSync('leg-report.md', 'utf8');
            const cidReport = fs.existsSync('cid-report.md') ? fs.readFileSync('cid-report.md', 'utf8') : '‚ö†Ô∏è Relat√≥rio CID n√£o dispon√≠vel.';
            const today = new Date().toISOString().split('T')[0];
            const broken = parseInt(process.env.BROKEN) || 0;
            const brokenAlert = broken > 0
              ? `\n‚ö†Ô∏è **${broken} link(s) com problema detectado(s)!** Verifique a se√ß√£o de links abaixo.\n`
              : '\n‚úÖ Todos os links responderam com sucesso.\n';

            const body = `# üìã Revis√£o Semanal ‚Äî ${today}

            **Vers√£o atual:** v${process.env.VERSAO}
            **√öltima atualiza√ß√£o:** ${process.env.ULTIMA}
            **Fontes cadastradas:** ${process.env.NUM_FONTES}
            **Categorias:** ${process.env.NUM_CATEGORIAS}
            ${brokenAlert}

            ## üè• Status do Site

            | Verifica√ß√£o | Resultado |
            |-------------|-----------|
            | Quality Gate | ${process.env.QG_STATUS} |
            | Health Probe (/healthz) | HTTP ${process.env.HEALTH_HZ} |
            | Custom Domain | HTTP ${process.env.HEALTH_CD} |
            | Redirect Azure | HTTP ${process.env.HEALTH_RD} |
            | CID (OMS ICD API) | ${process.env.CID_OK}/${process.env.CID_TOTAL} ‚úÖ |
            | **Status Geral** | **${process.env.HEALTH_OVERALL}** |

            ## Checklist de Revis√£o

            ### üìú Legisla√ß√£o
            - [ ] Verificar se houve altera√ß√µes legislativas (planalto.gov.br)
            - [ ] Conferir valores atualizados (sal√°rio m√≠nimo, BPC)
            - [ ] Checar novas leis ou decretos relevantes para PcD
            - [ ] Verificar Di√°rio Oficial da Uni√£o (in.gov.br) para portarias e decretos
            - [ ] Checar se houve mudan√ßas no Minha Casa Minha Vida (gov.br/cidades)

            ### üèõÔ∏è Servi√ßos
            - [ ] Testar links de servi√ßos (gov.br, INSS, ANS)
            - [ ] Verificar se os procedimentos/passos continuam os mesmos
            - [ ] Checar se h√° novos servi√ßos digitais dispon√≠veis

            ### üìã Conte√∫do
            - [ ] Revisar dicas e orienta√ß√µes por categoria
            - [ ] Verificar se documentos necess√°rios mudaram
            - [ ] Atualizar data de "ultima_atualizacao" e "proxima_revisao" no JSON

            ### üè† Categorias
            - [ ] Verificar se algum direito PcD novo surgiu (ver backlog no GOVERNANCE.md)
            - [ ] Checar se alguma categoria existente precisa de atualiza√ß√£o de valores
            - [ ] Verificar cobertura de institui√ß√µes para todas as categorias
            - [ ] Rodar \`python codereview/codereview.py --categoria schema\` para validar

            ### üîó Verifica√ß√£o Autom√°tica de Links
            ${linkReport}

            ### üìú Verifica√ß√£o Legislativa
            ${legReport}

            ### üè• Valida√ß√£o CID
            ${cidReport}

            ---
            *Issue criada automaticamente pelo workflow de revis√£o semanal.*
            *Consulte GOVERNANCE.md para crit√©rios de adi√ß√£o de fontes e categorias.*
            *Ap√≥s a revis√£o, atualize \`ultima_atualizacao\` e \`proxima_revisao\` em \`data/direitos.json\`.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìã Revis√£o semanal de fontes ‚Äî ${today}`,
              body: body,
              labels: ['revis√£o-semanal', 'fontes']
            });
