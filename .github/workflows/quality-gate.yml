# NossoDireito â€” Quality Gate Pipeline
# Executa verificaÃ§Ãµes de qualidade antes de qualquer deploy.
# Bloqueia push/PR se score < 75 ou se houver achado CRITICAL.

name: Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate (30 categorias)
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependÃªncias
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # â”€â”€ Testes Python (pytest) â”€â”€
      - name: Executar testes Python
        run: |
          echo "ðŸ§ª Executando testes Python..."
          python -m pytest tests/ -v --tb=short --ignore=tests/test_browser.py -q

      # â”€â”€ Sensitive Data Scan (pre-check rÃ¡pido) â”€â”€
      - name: Scan para dados sensÃ­veis
        run: |
          echo "ðŸ” Escaneando arquivos rastreados por segredos..."
          FOUND=0

          # PadrÃµes de segredos
          PATTERNS=(
            "-----BEGIN.*PRIVATE KEY-----"
            "-----BEGIN CERTIFICATE-----"
            "AKIA[0-9A-Z]{16}"
            "ghp_[a-zA-Z0-9]{36}"
            "sk-[a-zA-Z0-9]{20,}"
          )

          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(git grep -l -E "$pattern" -- ':!.github/' 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo "âŒ PadrÃ£o suspeito encontrado: $pattern"
              echo "$MATCHES"
              FOUND=$((FOUND + 1))
            fi
          done

          # Verificar extensÃµes sensÃ­veis
          for ext in pfx pem key p12 env; do
            FILES=$(git ls-files "*.${ext}" 2>/dev/null || true)
            if [ -n "$FILES" ]; then
              echo "âŒ Arquivo sensÃ­vel rastreado: $FILES"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ "$FOUND" -gt 0 ]; then
            echo ""
            echo "ðŸš« FALHOU: $FOUND padrÃ£o(Ãµes) de dados sensÃ­veis encontrado(s)!"
            exit 1
          fi

          echo "âœ… Nenhum dado sensÃ­vel detectado nos arquivos rastreados."

      # â”€â”€ ValidaÃ§Ã£o de ConteÃºdo â”€â”€
      - name: Validar ConteÃºdo (categorias, IPVA, matching engine)
        run: |
          echo "ðŸ” Validando estrutura de conteÃºdo..."
          python3 scripts/validate_content.py

      # â”€â”€ Quality Gate Principal â”€â”€
      - name: Executar Quality Gate (validate_all.py)
        run: |
          echo "ðŸ”Ž Executando Quality Gate..."
          python scripts/validate_all.py --quick

      # â”€â”€ Salvar relatÃ³rio como artefato â”€â”€
      - name: Copiar relatÃ³rio JSON
        if: always()
        run: |
          cp validation_report.json quality-gate-report.json 2>&1 || true

      - name: Upload relatÃ³rio
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report
          path: quality-gate-report.json
          retention-days: 30

      # â”€â”€ Resumo no GitHub Actions â”€â”€
      - name: Resumo do Quality Gate
        if: always()
        run: |
          echo "## ðŸ”Ž Quality Gate Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SCORE=$(python -c "
          import json, sys
          try:
              with open('quality-gate-report.json') as f:
                  data = json.load(f)
              print(f\"Score: **{data['score_total']}/100**\")
              print()
              print('| Categoria | Score |')
              print('|-----------|-------|')
              for cat, score in sorted(data['categorias_scores'].items(), key=lambda x: -x[1]):
                  emoji = 'âœ…' if score >= 80 else 'âš ï¸' if score >= 50 else 'âŒ'
                  print(f'| {emoji} {cat} | {score} |')
              print()
              criticals = sum(1 for a in data['achados'] if 'CRITICAL' in a.get('severidade', ''))
              errors = sum(1 for a in data['achados'] if 'ERROR' in a.get('severidade', ''))
              warnings = sum(1 for a in data['achados'] if 'WARNING' in a.get('severidade', ''))
              print(f'**CRITICAL:** {criticals} | **ERROR:** {errors} | **WARNING:** {warnings}')
          except Exception as e:
              print(f'Erro ao ler relatÃ³rio: {e}')
          " 2>&1)

          echo "$SCORE" >> $GITHUB_STEP_SUMMARY
